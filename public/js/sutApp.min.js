angular.module("sutApp",["ngRoute","appRoutes","ngFileUpload","ngImgCrop","ngMap"]);(function(){angular.module("sutApp").service("mailService",e);e.$inject=["$http"];function e(e){composeRegistrationEmail=function(e,o){e.message="Ciao,\n\n"+"grazie per esserti unito a noi. Per completare la registrazione fai clic sul seguente link:\n"+"http://sottountetto.org/conferma-registrazione/"+o+"\n\n"+"Ti ricordiamo che le operazioni che può fare sul sito sono:\n"+"- Proporre un tetto se sei di buon cuore\n"+"- Richiedere un tetto se è un'emergenza\n"+"- Consultare la mappa per guardare la situazione attuale\n\n"+"Le tue informazioni vengono trattate secondo la Legge n. 675 del 31 dicembre 1996 - Tutela delle persone e di altri soggetti rispetto al trattamento dei dati personali.\n"+"Leggi l'informativa di sottountetto.org a: "+"http://sottountetto.org/informativa/"+"\n\n"+"sottountetto.org TEAM\n"+"sottountetto.org - Copyright 2016 - Tutti i diritti riservati";return e};send=function(o){return e.post("/api/mail",o).success(function(e){console.log(e)})};return{composeRegistrationEmail:composeRegistrationEmail,send:send}}})();(function(){angular.module("sutApp").service("userService",e);e.$inject=["$http","$window","mailService"];function e(e,o,t){var r=function(e){o.localStorage["sut-token"]=e};var n=function(){return o.localStorage["sut-token"]};var a=function(){var e=n();if(!e||e=="undefined"){return false}else{var t=JSON.parse(o.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}};var s=function(){if(a()){var e=n();var t=JSON.parse(o.atob(e.split(".")[1]));return{id:t._id,email:t.email,firstname:t.firstname}}};var i=function(o){return e.get("/api/user/"+o)};signup=function(o){return e.post("/api/signup",o.lawyer).success(function(e){var r=t.composeRegistrationEmail(o.emailData,e._id);t.send(r)})};signupConfirmation=function(o){var t={userId:o};return e.put("/api/signup-confirmation",t).success(function(e){console.log(e)})};login=function(o){return e.post("/api/login",o).success(function(e){r(e.token)})};usersAll=function(){return e.get("api/users")};usersProposals=function(){return e.get("api/users/proposals")};usersRequests=function(){return e.get("api/users/requests")};avvocatoFilterBy=function(o){return e.get("api/avvocati/"+o)};studiolegaleAll=function(){return e.get("api/studilegali")};studiolegaleFilterBy=function(o){return e.get("api/studilegali/"+o)};update=function(o,t){var n={userId:o,formData:t};return e.put("api/addRoof",n).success(function(e){r(e.token)})};remove=function(o){return e.delete("/api/delete/"+o).success(function(){logout()})};logout=function(){o.localStorage.removeItem("sut-token")};return{currentUser:s,saveToken:r,getToken:n,isLoggedIn:a,signup:signup,signupConfirmation:signupConfirmation,login:login,logout:logout,userById:i,usersAll:usersAll,usersProposals:usersProposals,usersRequests:usersRequests,avvocatoFilterBy:avvocatoFilterBy,studiolegaleAll:studiolegaleAll,studiolegaleFilterBy:studiolegaleFilterBy,update:update,remove:remove}}})();(function(){angular.module("sutApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"js/common/directives/navigation/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("sutApp").controller("navigationCtrl",e);e.$inject=["$location","userService"];function e(e,o){var t=this;t.currentPath=e.path();t.isLoggedIn=o.isLoggedIn();t.currentUser=o.currentUser();t.logout=function(){o.logout();e.path("/")}}})();(function(){angular.module("sutApp").controller("signupCtrl",e);e.$inject=["$location","userService","$window"];function e(e,o,t){var r=this;r.formData={firstname:"",lastname:"",email:"",password:"",passwordRepeated:""};r.emailData={name:"sottountetto.org",email:"support@sottountetto.org",to:"",subject:"sottountetto.org: ben atterrato sulla piattaforma",message:""};r.onSubmit=function(){r.formError="";r.formSuccess="";if(!r.formData.firstname||!r.formData.lastname||!r.formData.email||!r.formData.password||!r.formData.passwordRepeated){r.formError="Tutti i campi sono obbligatori, per favore ricompilali.";return false}else if(r.formData.password!=r.formData.passwordRepeated){r.formError="Le password devono coincidere.";return false}else{r.emailData.to=r.formData.email;r.doRegistration()}};r.doRegistration=function(){r.formError="";r.formSuccess="";var e={lawyer:r.formData,emailData:r.emailData};o.signup(e).error(function(e){r.formError="Qualcosa è andato storto."}).then(function(){r.formSuccess="Ti sei registrato. Adesso controlla la tua casella di posta elettronica."})}}})();(function(){angular.module("sutApp").controller("loginCtrl",e);e.$inject=["$location","userService"];function e(e,o){var t=this;t.credentials={email:"",password:""};t.onSubmit=function(){t.formError="";if(!t.credentials.email||!t.credentials.password){t.formError="Tutti i campi sono obbligatori, per favore ricompilali.";return false}else{t.doLogin()}};t.doLogin=function(){t.formError="";o.login(t.credentials).error(function(e){t.formError=e.message}).then(function(){e.path("/")})}}})();(function(){angular.module("sutApp").controller("signupConfirmationCtrl",e);e.$inject=["$location","$window","$routeParams","userService"];function e(e,o,t,r){var n=this;n.userId=t.userId;r.signupConfirmation(n.userId).error(function(e){console.log(e)}).then(function(){console.log("Il tuo profilo è stato confermato.")})}})();(function(){angular.module("sutApp").controller("addRoofCtrl",e);e.$inject=["$location","userService","$window","NgMap","$routeParams"];function e(e,o,t,r,n){var a=this;a.userId=n.userId;a.currentUser=o.currentUser();a.isLoggedIn=o.isLoggedIn();a.checkValidity=function(){if(!a.isLoggedIn){return false}if(a.userId==a.currentUser.id){return true}else{return false}};o.userById(a.userId).success(function(e){a.data={user:e};if(a.data.user.home.purpose=="richieste")a.data={user:{home:{}}}}).error(function(e){console.log(e)});a.formData={purpose:"proposte",address:"",numBed:""};a.types="['address']";a.placeChanged=function(){a.place=this.getPlace();a.home={location:a.place.geometry.location,address:a.place.formatted_address};a.map.setCenter(a.place.geometry.location)};r.getMap().then(function(e){a.map=e});a.onSubmit=function(){a.formData.address=a.data.user.home.address;a.formData.numBed=a.data.user.home.numBed;a.doModification()};a.doModification=function(){a.formError="";o.update(a.userId,a.formData).error(function(e){a.formError=e.message}).then(function(){e.path("/")})}}})();(function(){angular.module("sutApp").controller("askRoofCtrl",e);e.$inject=["$location","userService","$window","NgMap","$routeParams"];function e(e,o,t,r,n){var a=this;a.userId=n.userId;a.currentUser=o.currentUser();a.isLoggedIn=o.isLoggedIn();a.checkValidity=function(){if(!a.isLoggedIn){return false}if(a.userId==a.currentUser.id){return true}else{return false}};o.userById(a.userId).success(function(e){a.data={user:e};if(a.data.user.home.purpose=="proposte")a.data={user:{home:{}}}}).error(function(e){console.log(e)});a.formData={purpose:"richieste",address:"",numBed:""};a.types="['address']";a.placeChanged=function(){a.place=this.getPlace();a.home={location:a.place.geometry.location,address:a.place.formatted_address};a.map.setCenter(a.place.geometry.location)};r.getMap().then(function(e){a.map=e});a.onSubmit=function(){a.formData.address=a.data.user.home.address;a.formData.numBed=a.data.user.home.numBed;a.doModification()};a.doModification=function(){a.formError="";o.update(a.userId,a.formData).error(function(e){a.formError=e.message}).then(function(){e.path("/")})}}})();(function(){angular.module("sutApp").controller("findCtrl",e);e.$inject=["$routeParams","NgMap","userService","$location"];function e(e,o,t,r){var n=this;n.dynMarkers=[];o.getMap().then(function(e){n.map=e});n.showDetail=function(e,o){n.user=o;n.map.showInfoWindow("foo-iw",o._id)};n.getProfile=function(e){r.path("/profilo/"+e._id)};t.usersProposals().success(function(e){n.data={users:e};n.positions=[];for(l in n.data.users){n.positions.push(n.data.users[l].home.address)}n.user=n.data.users[0]}).error(function(e){console.log(e)});t.usersRequests().success(function(e){n.data2={users2:e};n.positions2=[];for(l in n.data2.users2){n.positions2.push(n.data2.users2[l].home.address)}n.user2=n.data2.users2[0]}).error(function(e){console.log(e)});n.onSubmit=function(){if(n.type=="Tipologia"){r.path("/cerca")}else if(n.type=="Proposte"){r.path("/cerca/proposte")}else if(n.type=="Richieste"){r.path("/cerca/richieste")}}}})();(function(){angular.module("sutApp").controller("homeCtrl",e);e.$inject=["$location"];function e(e){var o=this}})();(function(){angular.module("sutApp").controller("findProposalsCtrl",e);e.$inject=["$routeParams","NgMap","userService","$location"];function e(e,o,t,r){var n=this;n.dynMarkers=[];o.getMap().then(function(e){n.map=e});n.showDetail=function(e,o){n.user=o;n.map.showInfoWindow("foo-iw",o._id)};n.getProfile=function(e){r.path("/user/"+e._id)};t.usersProposals().success(function(e){n.data={users:e};n.positions=[];for(l in n.data.users){n.positions.push(n.data.users[l].home.address)}n.user=n.data.users[0]}).error(function(e){console.log(e)});n.onSubmit=function(){if(n.type=="Tipologia"){r.path("/cerca")}else if(n.type=="Proposte"){r.path("/cerca/proposte")}else if(n.type=="Richieste"){r.path("/cerca/richieste")}}}})();(function(){angular.module("sutApp").controller("findRequestsCtrl",e);e.$inject=["$routeParams","NgMap","userService","$location"];function e(e,o,t,r){var n=this;n.dynMarkers=[];o.getMap().then(function(e){n.map=e});n.showDetail=function(e,o){n.user=o;n.map.showInfoWindow("foo-iw",o._id)};n.getProfile=function(e){r.path("/user/"+e._id)};t.usersRequests().success(function(e){n.data2={users2:e};n.positions2=[];for(l in n.data2.users2){n.positions2.push(n.data2.users2[l].home.address)}n.user2=n.data2.users2[0]}).error(function(e){console.log(e)});n.onSubmit=function(){if(n.type=="Tipologia"){r.path("/cerca")}else if(n.type=="Proposte"){r.path("/cerca/proposte")}else if(n.type=="Richieste"){r.path("/cerca/richieste")}}}})();(function(){angular.module("sutApp").controller("profileCtrl",e);e.$inject=["$routeParams","userService","NgMap","Upload","$location","mailService"];function e(e,o,t,r,n,a){var s=this;s.formData={message:""};s.emailData={name:"sottountetto.org",email:"support@sottountetto.org",to:"",subject:"sottountetto.org: ci sono novita'",message:""};s.userId=e.userId;o.userById(s.userId).success(function(e){s.data={user:e}}).error(function(e){console.log(e)});s.onSubmit=function(){s.formError="";s.formSuccess="";if(!s.formData.message){s.formError="Il campo messaggio e' obbligatorio.";return false}else{if(s.data.user.email){s.emailData.to=s.data.user.email;s.emailData.message=s.formData.message+"\n\nRicevi questa email dal servizio sottountetto.org"}else{s.formError="Errore. Aggiorna la pagina e riprova."}s.sendEmail()}};s.sendEmail=function(){s.formError="";s.formSuccess="";a.send(s.emailData).error(function(e){s.formError="Qualcosa è andato storto."}).then(function(){s.formSuccess="Il messaggio è stato inviato."})}}})();(function(){angular.module("sutApp").controller("deleteProfileCtrl",e);e.$inject=["$location","$window","$routeParams","userService"];function e(e,o,t,r){var n=this;n.userId=t.userId;n.onSubmit=function(){n.doElimination()};n.doElimination=function(){n.formError="";r.remove(n.userId).error(function(e){n.formError=e}).then(function(){e.path("/");o.scrollTo(0,0)})}}})();